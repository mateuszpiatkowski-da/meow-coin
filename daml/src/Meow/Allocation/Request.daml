module Meow.Allocation.Request where

import Splice.Api.Token.AllocationRequestV1 qualified as AllReq
import Splice.Api.Token.AllocationV1 qualified as Alloc
import Splice.Api.Token.MetadataV1 qualified as Meta
import DA.TextMap qualified as TM
import DA.List qualified as List

-- Helper functions to extract senders and receivers
getSenders : [(Text, Alloc.TransferLeg)] -> [Party]
getSenders transferLegList = map (\(_, leg) -> leg.sender) transferLegList

getReceivers : [(Text, Alloc.TransferLeg)] -> [Party]
getReceivers transferLegList = map (\(_, leg) -> leg.receiver) transferLegList

template MeowAllocationRequest
  with
    settlement : Alloc.SettlementInfo
    transferLegList : [(Text, Alloc.TransferLeg)]
  where
    signatory getSenders transferLegList
    observer settlement.executor :: getReceivers transferLegList

    -- this is a helper choice to extract a transferLeg using its ID
    nonconsuming choice GetTransferLeg : Optional Alloc.TransferLeg
      with
        transferLegId : Text
        actor : Party
      controller actor
      do
        assertMsg "Only signatories and observers can fetch transfer legs" 
          (actor `elem` (settlement.executor :: getSenders transferLegList ++ getReceivers transferLegList))
        let index = List.findIndex (\(id, _) -> id == transferLegId) transferLegList
        pure (case index of
          Some idx -> Some (snd (transferLegList List.!! idx))
          None -> None)

    interface instance AllReq.AllocationRequest for MeowAllocationRequest where
      view = AllReq.AllocationRequestView with
        settlement
        transferLegs = TM.fromList transferLegList
        meta = Meta.emptyMetadata

      -- NOTE: the naming convention should be `..._rejectImpl` for consistency
      allocationRequest_RejectImpl this rejectRequest = do
        let senders = map (\(_, leg) -> leg.sender) transferLegList
        assertMsg "The choice can be exercised only by senders" (rejectRequest.actor `elem` senders)
        pure Meta.ChoiceExecutionMetadata with
          meta = Meta.emptyMetadata


      allocationRequest_WithdrawImpl this withdrawRequest = do
        pure Meta.ChoiceExecutionMetadata with
          meta = Meta.emptyMetadata
