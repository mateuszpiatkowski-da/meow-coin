module Test where

import Daml.Script
import Meow.Token
import Meow.Transfer
import DA.Time qualified as Time
import Splice.Api.Token.MetadataV1 qualified as Meta
import Splice.Api.Token.HoldingV1 qualified as Holding
import Splice.Api.Token.TransferInstructionV1 qualified as Transfer
import DA.Date qualified as Date
import Fixture.Token (TokenFixture(..), setupTokenTest)

test_token = script do
  TokenFixture{admin, oldOwner, newOwner, tokenCid} <- setupTokenTest

  Some token <- queryContractId admin tokenCid

  -- Set ledger time to a realistic value (e.g., 2024-01-01)
  setTime (Time.time (Date.date 2024 Date.Jan 1) 0 0 0)
  now <- getTime
  let nowPlus24H = Time.addRelTime now (Time.hours 24 + Time.minutes 25)
  let holdingView = view $ toInterface @Holding.Holding token
  let instrumentId = holdingView.instrumentId
  let holdingCid = toInterfaceContractId @Holding.Holding tokenCid

  transferFactoryCid <- submit admin $
    toInterfaceContractId @Transfer.TransferFactory <$> createCmd MeowTransferFactory
      with
        admin

  -- Extract the transfer instruction contract ID from the result
  result <- submitMulti [admin, oldOwner] [] do
    exerciseCmd transferFactoryCid Transfer.TransferFactory_Transfer with
      expectedAdmin = admin
      transfer = Transfer.Transfer with
        sender = oldOwner
        receiver = newOwner
        amount = tokenAmount
        instrumentId
        requestedAt = now
        executeBefore = nowPlus24H
        inputHoldingCids = [holdingCid]
        meta = Meta.emptyMetadata
      extraArgs = Meta.ExtraArgs with
        context = Meta.emptyChoiceContext
        meta = Meta.emptyMetadata

  let Transfer.TransferInstructionResult_Pending{transferInstructionCid} = result.output

  -- Now accept the transfer as the receiver
  submitMulti [admin, newOwner] [] do
    exerciseCmd transferInstructionCid Transfer.TransferInstruction_Accept with
      extraArgs = Meta.ExtraArgs with
        context = Meta.emptyChoiceContext
        meta = Meta.emptyMetadata

  pure ()

