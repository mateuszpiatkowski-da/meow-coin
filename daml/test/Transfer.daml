module Transfer where

import Daml.Script
import Meow.Transfer
import DA.Time qualified as Time
import Splice.Api.Token.MetadataV1 qualified as Meta
import Splice.Api.Token.HoldingV1 qualified as Holding
import Splice.Api.Token.TransferInstructionV1 qualified as Transfer
import Fixture.Token qualified as F.Token
import Util.SetTime (set_ledger_time)
import Util.ExtraArgs (emptyExtraArgs)

test_transfer : Decimal -> Decimal -> Script ()
test_transfer startAmount amountToTransfer = script do
  assertMsg "startAmount and amountToTransfer must be valid" (startAmount >= amountToTransfer && amountToTransfer >= 0.0)
  F.Token.TokenFixture{admin, sender, receiver, tokenCid} <- F.Token.setup_token_test startAmount

  Some token <- queryContractId admin tokenCid

  set_ledger_time
  now <- getTime
  let nowPlus24H = Time.addRelTime now (Time.hours 24 + Time.minutes 25)
  let holdingView = view $ toInterface @Holding.Holding token
  let instrumentId = holdingView.instrumentId
  let holdingCid = toInterfaceContractId @Holding.Holding tokenCid

  transferFactoryCid <- submit admin $
    toInterfaceContractId @Transfer.TransferFactory <$> createCmd MeowTransferFactory
      with
        admin

  -- Extract the transfer instruction contract ID from the result
  result <- submitMulti [admin, sender] [] do
    exerciseCmd transferFactoryCid Transfer.TransferFactory_Transfer with
      expectedAdmin = admin
      transfer = Transfer.Transfer with
        sender
        receiver
        amount = amountToTransfer
        instrumentId
        requestedAt = now
        executeBefore = nowPlus24H
        inputHoldingCids = [holdingCid]
        meta = Meta.emptyMetadata
      extraArgs = emptyExtraArgs

  let Transfer.TransferInstructionResult_Pending{transferInstructionCid} = result.output

  -- Now accept the transfer as the receiver
  submitMulti [admin, receiver] [] do
    exerciseCmd transferInstructionCid Transfer.TransferInstruction_Accept with
      extraArgs = emptyExtraArgs

  pure ()


test_partial_transfer : Script ()
test_partial_transfer = script do
  test_transfer 100.0 46.6532
  pure ()

test_full_transfer : Script ()
test_full_transfer = script do
  test_transfer 100.0 100.0
  pure ()
