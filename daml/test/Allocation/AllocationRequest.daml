module Allocation.AllocationRequest where

import Daml.Script
import DA.Time qualified as Time
import Meow.Allocation.Request
import Splice.Api.Token.AllocationV1 qualified as Alloc
import Splice.Api.Token.MetadataV1 qualified as Meta
import Splice.Api.Token.HoldingV1 qualified as Holding
import Splice.Api.Token.AllocationRequestV1 qualified as AllocReq
import Util.ExtraArgs qualified as U.ExtraArgs
import Util.SetTime (setLedgerTime)
import Fixture.Parties qualified as F.Parties

testAllocationRequest : Script (ContractId MeowAllocationRequest)
testAllocationRequest = script do
  setLedgerTime
  parties <- F.Parties.createParties
  testAllocationRequestWithParties parties (100.0, 35.64564)

testAllocationRequestWithParties : F.Parties.Parties -> (Decimal, Decimal) -> Script (ContractId MeowAllocationRequest)
testAllocationRequestWithParties F.Parties.Parties{admin, receiver, sender, anotherSender, executor} (senderAmount, anotherSenderAmount) = script do

  now <- getTime
  let allocateBefore = Time.addRelTime now (Time.hours 48)
  let settleBefore = Time.addRelTime allocateBefore (Time.minutes 10)

  let settlement = Alloc.SettlementInfo with
        executor
        settlementRef = Alloc.Reference with
          id = "requestId"
          cid = None
        requestedAt = now
        allocateBefore
        settleBefore
        meta = Meta.emptyMetadata

  let transferLeg1 = Alloc.TransferLeg with
        sender
        receiver
        amount = senderAmount
        instrumentId = Holding.InstrumentId with
          admin
          id = "instrumentId1"
        meta = Meta.emptyMetadata
  let transferLeg2 = Alloc.TransferLeg with
        sender = anotherSender
        receiver
        amount = anotherSenderAmount
        instrumentId = Holding.InstrumentId with
          admin
          id = "instrumentId2"
        meta = Meta.emptyMetadata
  let transferLegList = [("senderTransferLegId", transferLeg1), ("anotherSenderTransferLegId", transferLeg2)]

  meowAllocationRequestCid <- submitMulti [sender, anotherSender] [] do
    createCmd MeowAllocationRequest with
      settlement
      transferLegList
  let allocationRequestCid = toInterfaceContractId @AllocReq.AllocationRequest meowAllocationRequestCid

  -- only executor can do it
  submitMustFail sender do
    exerciseCmd allocationRequestCid AllocReq.AllocationRequest_Withdraw with
      extraArgs = U.ExtraArgs.emptyExtraArgs

  -- only specified actor (sender of any transferLeg) can do it
  submitMustFail receiver do
    exerciseCmd allocationRequestCid AllocReq.AllocationRequest_Reject with
      actor = receiver
      extraArgs = U.ExtraArgs.emptyExtraArgs

  Some transferLeg <- submit executor do
    exerciseCmd meowAllocationRequestCid GetTransferLeg with
      transferLegId = "anotherSenderTransferLegId"
      actor = executor

  assertMsg "GetTransferLeg isn't working properly" (transferLeg == transferLeg2)

  pure meowAllocationRequestCid
