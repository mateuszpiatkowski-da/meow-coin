module Allocation.AllocationInstruction where

import Daml.Script
import Meow.Allocation.Instruction qualified as MeowAllInstr
import Fixture.Parties qualified as F.Parties
import Util.SetTime (set_ledger_time)
import Util.ExtraArgs (emptyExtraArgs)
import Allocation.AllocationRequest qualified as Test.AllocReq
import Splice.Api.Token.AllocationRequestV1 qualified as AllocReq
import Splice.Api.Token.AllocationV1 qualified as Alloc
import Splice.Api.Token.AllocationInstructionV1 qualified as AllocInstr
import DA.TextMap qualified as TM
import DA.List qualified as List
import Fixture.Token qualified as F.Token
import Splice.Api.Token.MetadataV1 qualified as Meta
import Meow.Util qualified as Util

create_allocation_instruction = script do
  F.Parties.Parties{admin, receiver, sender, executor} <- F.Parties.create_parties

  set_ledger_time

  -- prepare allocation data via MeowAllocationRequest
  meowAllocRequestCid <- Test.AllocReq.test_allocation_request_with_parties F.Parties.Parties{admin, receiver, sender, anotherSender, executor}
  Some meowAllocRequest <- queryContractId executor meowAllocRequestCid
  let allocRequestView = view (toInterface @AllocReq.AllocationRequest meowAllocRequest)

  let (transferLegId, transferLeg) = List.head $ TM.toList allocRequestView.transferLegs
  let sender = transferLeg.sender

  let allocation = Alloc.AllocationSpecification with
        settlement = allocRequestView.settlement
        transferLegId
        transferLeg

  -- create MeowAllocationInstructionFactory
  standaloneMeowFactoryCid <- submit admin do
    createCmd MeowAllInstr.MeowAllocationInstructionFactory with
      admin
      observers = []

  meowFactoryCid <- submit admin do
    exerciseCmd standaloneMeowFactoryCid MeowAllInstr.AddObserver with
      newObservers = [sender]

  let factoryCid = toInterfaceContractId @AllocInstr.AllocationFactory meowFactoryCid

  now <- getTime

  -- create tokens as inputs
  meowHolding1 <- F.Token.create_test_token admin sender 24.234223
  meowHolding2 <- F.Token.create_test_token admin sender 2.54423
  let holding1 = Util.meowTokenToHoldingCid meowHolding1
  let holding2 = Util.meowTokenToHoldingCid meowHolding2


  -- create MeowAllocationInstruction
  factoryAllocationResult <- submit sender do
    exerciseCmd factoryCid AllocInstr.AllocationFactory_Allocate with
      expectedAdmin = admin
      allocation
      requestedAt = now
      inputHoldingCids = [holding1, holding2]
      extraArgs = emptyExtraArgs

  let allocationCid = factoryAllocationResult.output.allocationInstructionCid

  pure (allocationCid, admin, sender, receiver, executor)

test_allocation_instruction_withdraw = script do
  (allocationCid, admin, sender, receiver, executor) <- create_allocation_instruction
  submit sender do
    exerciseCmd allocationCid AllocInstr.AllocationInstruction_Withdraw with
      extraArgs = emptyExtraArgs
  pure ()

test_allocation_instruction_update = script do
  (allocationCid, admin, sender, receiver, executor) <- create_allocation_instruction
  -- must be both sender and receiver
  -- submitMultiMustFail [sender, admin] [] do
  --   exerciseCmd allocationCid AllocInstr.AllocationInstruction_Update with
  --     extraActors = [sender]
  --     extraArgs = Meta.ExtraArgs with
  --       context = Meta.ChoiceContext with
  --         values = TM.fromList [("amount", Meta.AV_Decimal 54.6234)]
  --       meta = Meta.emptyMetadata

  result <- submitMulti [sender, receiver, admin] [] do
    exerciseCmd allocationCid AllocInstr.AllocationInstruction_Update with
      extraActors = [sender, receiver]
      extraArgs = Meta.ExtraArgs with
        context = Meta.ChoiceContext with
          values = TM.fromList [("amount", Meta.AV_Decimal 4.6234)]
        meta = Meta.emptyMetadata

  let newAllocationCid = result.output.allocationInstructionCid
  Some newView <- queryInterfaceContractId @AllocInstr.AllocationInstruction sender newAllocationCid

  assertMsg "Amount should be updated to 4.6234" (newView.allocation.transferLeg.amount == 4.6234)
  pure ()
