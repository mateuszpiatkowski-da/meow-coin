module Allocation.AllocationInstruction where

import Daml.Script
import Fixture.Parties qualified as F.Parties
import Util.SetTime (setLedgerTime)
import Util.ExtraArgs (emptyExtraArgs)
import Splice.Api.Token.AllocationInstructionV1 qualified as AllocInstr
import Fixture.AllocationInstruction qualified as F.AllocInstr
import Fixture.Allocation (createAllocation)

testAllocationInstructionWithdraw = script do
  setLedgerTime
  F.AllocInstr.AllocationInstructionFixture{allocationCid, anotherAllocationCid, parties = F.Parties.Parties{admin, sender, anotherSender, receiver, executor}} <- F.AllocInstr.createAllocationInstruction (100.0, [99.5343, 2.5321]) (50.0, [15.32])
  submit sender do
    exerciseCmd allocationCid AllocInstr.AllocationInstruction_Withdraw with
      extraArgs = emptyExtraArgs
  -- only a designated sender can withdraw their own allocation instruction
  submitMustFail sender do
    exerciseCmd anotherAllocationCid AllocInstr.AllocationInstruction_Withdraw with
      extraArgs = emptyExtraArgs
  submit anotherSender do
    exerciseCmd anotherAllocationCid AllocInstr.AllocationInstruction_Withdraw with
      extraArgs = emptyExtraArgs
  pure ()

testAllocationInstructionUpdate = script do
  setLedgerTime
  createAllocation
  pure ()
